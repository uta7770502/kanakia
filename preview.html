<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>é…å¸ƒç¢ºèª | ã‚«ãƒŠãƒªã‚¢é€šä¿¡</title>

  <style>
    :root{
      --bg:#f5f6f8;
      --card:#fff;
      --text:#1f2328;
      --muted:#6b7280;
      --line:#e5e7eb;
      --brand:#4fc3c7;
      --accent:#2fb34a;
      --accent2:#1aa65a;
      --shadow: 0 10px 30px rgba(0,0,0,.08);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:-apple-system,BlinkMacSystemFont,"Noto Sans JP","Hiragino Sans","Helvetica Neue",Arial,sans-serif;
      background:var(--bg);
      color:var(--text);
    }

    /* ä¸Šéƒ¨ãƒãƒ¼ */
    .topbar{
      position:sticky; top:0; z-index:50;
      background:linear-gradient(180deg, rgba(79,195,199,.22), rgba(79,195,199,0));
      padding:12px 12px 8px;
      backdrop-filter: blur(6px);
    }
    .topbar-inner{
      max-width:980px;
      margin:0 auto;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }
    .brand{
      display:flex; align-items:center; gap:10px;
      font-weight:900;
    }
    .badge{
      width:38px; height:38px; border-radius:12px;
      display:grid; place-items:center;
      background:#fff;
      box-shadow: var(--shadow);
      border:1px solid var(--line);
      font-size:20px;
    }
    .brand small{display:block; font-weight:700; color:var(--muted); margin-top:2px}
    .btns{display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end}
    .btn{
      appearance:none;
      border:1px solid var(--line);
      background:#fff;
      padding:10px 12px;
      border-radius:12px;
      font-weight:900;
      cursor:pointer;
      box-shadow: 0 6px 18px rgba(0,0,0,.06);
      color:#111;
    }
    .btn.primary{
      background:linear-gradient(135deg,var(--accent),var(--accent2));
      color:#fff;
      border:none;
      box-shadow:0 10px 18px rgba(47,179,74,.22);
    }

    /* ãƒšãƒ¼ãƒ‘ãƒ¼ */
    .wrap{
      max-width:980px;
      margin:10px auto 80px;
      padding:0 12px;
    }
    .paper{
      background:var(--card);
      border:1px solid var(--line);
      border-radius: 22px;
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .paper-head{
      padding:18px 18px 14px;
      background: linear-gradient(180deg, rgba(79,195,199,.28), rgba(79,195,199,.06));
      border-bottom:1px solid var(--line);
    }
    .paper-title{
      display:flex; align-items:flex-end; gap:10px;
      flex-wrap:wrap;
    }
    .paper-title h1{
      font-size:26px;
      letter-spacing:.02em;
      margin:0;
    }
    .paper-title .month{
      font-size:22px;
      font-weight:900;
    }
    .paper-sub{
      margin-top:10px;
      background:#fff;
      border:1px solid var(--line);
      border-radius:14px;
      padding:10px 12px;
      color:#0f766e;
      font-weight:900;
      display:flex;
      align-items:center;
      gap:8px;
    }
    .paper-sub span{
      display:inline-grid; place-items:center;
      width:28px; height:28px; border-radius:10px;
      background:rgba(79,195,199,.18);
      color:#0f766e;
      font-size:16px;
      border:1px solid rgba(79,195,199,.25);
    }

    /* ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ */
    .cal{ padding:16px; }
    .cal-grid{
      display:grid;
      grid-template-columns: repeat(7, 1fr);
      gap:10px;
    }
    .dow{
      font-weight:900;
      color:var(--muted);
      text-align:center;
      font-size:13px;
      padding:6px 0;
    }
    .dow.sun{color:#ef4444}
    .dow.sat{color:#3b82f6}

    .cell{
      min-height:92px;
      border:1px solid var(--line);
      border-radius:16px;
      padding:10px 10px 8px;
      background:#fff;
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .cell.muted{
      opacity:.35;
      background:#fafafa;
    }
    .date{
      font-weight:900;
      font-size:14px;
      color:#111827;
    }
    .pill{
      margin-top:auto;
      border-radius:999px;
      padding:10px 12px;
      border:1px solid rgba(0,0,0,.06);
      display:flex;
      align-items:center;
      gap:10px;
      font-weight:900;
      line-height:1.1;
      min-height:46px;
      box-shadow: 0 8px 18px rgba(0,0,0,.08);
      overflow:hidden;
    }
    .pill .emoji{
      width:30px; height:30px;
      display:grid; place-items:center;
      border-radius:999px;
      background: rgba(255,255,255,.6);
      border:1px solid rgba(255,255,255,.55);
      font-size:18px;
      flex:0 0 auto;
    }
    .pill .label{
      flex:1;
      font-size:14px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .legend{
      border-top:1px dashed var(--line);
      padding:14px 16px;
      display:flex;
      flex-wrap:wrap;
      gap:8px 10px;
      align-items:center;
      color:var(--muted);
      font-weight:900;
      font-size:13px;
    }
    .legend .dot{
      display:inline-flex; align-items:center; gap:6px;
      padding:6px 10px;
      border:1px solid var(--line);
      border-radius:999px;
      background:#fff;
    }
    .legend .sw{
      width:12px; height:12px; border-radius:999px;
      border:1px solid rgba(0,0,0,.08);
      display:inline-block;
    }

    /* toast */
    .toast{
      position:fixed;
      left:50%;
      transform:translateX(-50%);
      bottom:18px;
      background:#111827;
      color:#fff;
      padding:10px 12px;
      border-radius:12px;
      font-weight:900;
      box-shadow: 0 10px 30px rgba(0,0,0,.25);
      opacity:0;
      pointer-events:none;
      transition:.2s;
      max-width: calc(100vw - 24px);
      text-align:center;
      z-index:9999;
    }
    .toast.show{opacity:1}

    /* å°åˆ·ï¼ˆPDFï¼‰ */
    @media print{
      body{background:#fff}
      .topbar{display:none}
      .wrap{margin:0; padding:0}
      .paper{ box-shadow:none; border:none; border-radius:0; }
      @page { size: A4; margin: 10mm; }
    }
  </style>
</head>

<body>
  <div class="topbar">
    <div class="topbar-inner">
      <div class="brand">
        <div class="badge">ğŸ¤</div>
        <div>
          <div>ã‚«ãƒŠãƒªã‚¢é€šä¿¡ <span style="font-weight:900;">ï¼ˆé…å¸ƒç¢ºèªï¼‰</span></div>
          <small id="subInfo">å®Œæˆç‰ˆã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ï¼ˆPDF / å…±æœ‰ï¼‰</small>
        </div>
      </div>

      <div class="btns">
        <button class="btn" id="backBtn">â† æˆ»ã‚‹</button>
        <button class="btn primary" id="pdfBtn">PDFã«ã™ã‚‹</button>
        <button class="btn" id="shareBtn">å…±æœ‰</button>
      </div>
    </div>
  </div>

  <div class="wrap">
    <div class="paper">
      <div class="paper-head">
        <div class="paper-title">
          <h1>ã‚«ãƒŠãƒªã‚¢é€šä¿¡</h1>
          <div class="month" id="monthLabel">----</div>
        </div>
        <div class="paper-sub">
          <span>ğŸ“£</span>
          <div>å®Œæˆç‰ˆã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã§ã™ã€‚ã”å®¶åº­ã§ã®ç¢ºèªãƒ»æ²ç¤ºãƒ»å…±æœ‰ã«ã”åˆ©ç”¨ãã ã•ã„ã€‚</div>
        </div>
      </div>

      <div class="cal">
        <div class="cal-grid">
          <div class="dow sun">æ—¥</div><div class="dow">æœˆ</div><div class="dow">ç«</div><div class="dow">æ°´</div><div class="dow">æœ¨</div><div class="dow">é‡‘</div><div class="dow sat">åœŸ</div>
        </div>
        <div class="cal-grid" id="grid"></div>
      </div>

      <div class="legend" id="legend"></div>
    </div>
  </div>

  <div class="toast" id="toast">ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ</div>

  <script>
    // ===== 2ãƒšãƒ¼ã‚¸ç›®ã¨æ•´åˆã™ã‚‹ â€œæœ€ä½é™ã®è¡¨ç¤ºç”¨è¾æ›¸â€ =====
    // 2ãƒšãƒ¼ã‚¸ç›®ã®ä¿å­˜ï¼š{ "YYYY-MM-DD": {genreId, actionId} }
    // ã“ã“ã§ã¯ â€œå®Œæˆç‰ˆã¨ã—ã¦è¦‹ãˆã‚‹â€ ãŸã‚ã« actionIdâ†’(emoji,label), genreIdâ†’è‰² ã‚’æŒã¤
    const GENRES = [
      { id:"sport",  color:"#ff8a65", actions:[
        { id:"sport-run", label:"ã‹ã‘ã£ã“", emoji:"ğŸƒâ€â™‚ï¸" },
        { id:"sport-ball", label:"ãƒœãƒ¼ãƒ«éŠã³", emoji:"âš½ï¸" },
        { id:"sport-dance", label:"ãƒ€ãƒ³ã‚¹", emoji:"ğŸ’ƒ" },
        { id:"sport-gym", label:"ã‚µãƒ¼ã‚­ãƒƒãƒˆ", emoji:"ğŸ¤¸" },
        { id:"sport-walk", label:"æ•£æ­©", emoji:"ğŸš¶" },
        { id:"sport-game", label:"é‹å‹•ã‚²ãƒ¼ãƒ ", emoji:"ğŸ¸" },
      ]},
      { id:"finger", color:"#9575cd", actions:[
        { id:"finger-cut", label:"ã¯ã•ã¿", emoji:"âœ‚ï¸" },
        { id:"finger-fold", label:"æŠ˜ã‚Šç´™", emoji:"ğŸ“„" },
        { id:"finger-bead", label:"ã²ã‚‚é€šã—", emoji:"ğŸ§µ" },
        { id:"finger-peg", label:"æ´—æ¿¯ã°ã•ã¿", emoji:"ğŸ“" },
        { id:"finger-clay", label:"ç²˜åœŸ", emoji:"ğŸ§±" },
        { id:"finger-puzzle", label:"ãƒ‘ã‚ºãƒ«", emoji:"ğŸ§©" },
      ]},
      { id:"focus",  color:"#4db6ac", actions:[
        { id:"focus-worksheet", label:"ãƒ¯ãƒ¼ã‚¯", emoji:"ğŸ“" },
        { id:"focus-maze", label:"è¿·è·¯", emoji:"ğŸŒ€" },
        { id:"focus-math", label:"æ•°ã‚ãã³", emoji:"ğŸ”¢" },
        { id:"focus-letter", label:"ã“ã¨ã°", emoji:"ğŸ”¤" },
        { id:"focus-memory", label:"è¨˜æ†¶ã‚²ãƒ¼ãƒ ", emoji:"ğŸ§ " },
        { id:"focus-time", label:"æ™‚è¨ˆ", emoji:"ğŸ•’" },
      ]},
      { id:"craft",  color:"#fbc02d", actions:[
        { id:"craft-paint", label:"ã¬ã‚Šçµµ", emoji:"ğŸ–ï¸" },
        { id:"craft-paper", label:"ç´™å·¥ä½œ", emoji:"ğŸ“" },
        { id:"craft-season", label:"å­£ç¯€åˆ¶ä½œ", emoji:"ğŸ" },
        { id:"craft-collage", label:"ã‚³ãƒ©ãƒ¼ã‚¸ãƒ¥", emoji:"ğŸ“°" },
        { id:"craft-mask", label:"ãŠé¢", emoji:"ğŸ­" },
        { id:"craft-card", label:"ã‚«ãƒ¼ãƒ‰ä½œã‚Š", emoji:"ğŸ’Œ" },
      ]},
      { id:"cook",   color:"#81c784", actions:[
        { id:"cook-sand", label:"ã‚µãƒ³ãƒ‰", emoji:"ğŸ¥ª" },
        { id:"cook-salad", label:"ã‚µãƒ©ãƒ€", emoji:"ğŸ¥—" },
        { id:"cook-onigiri", label:"ãŠã«ãã‚Š", emoji:"ğŸ™" },
        { id:"cook-soup", label:"ã‚¹ãƒ¼ãƒ—", emoji:"ğŸ²" },
        { id:"cook-egg", label:"ãŸã¾ã”", emoji:"ğŸ³" },
        { id:"cook-fruit", label:"ãƒ•ãƒ«ãƒ¼ãƒ„", emoji:"ğŸ" },
      ]},
      { id:"snack",  color:"#ffb74d", actions:[
        { id:"snack-cookie", label:"ã‚¯ãƒƒã‚­ãƒ¼", emoji:"ğŸª" },
        { id:"snack-jelly", label:"ã‚¼ãƒªãƒ¼", emoji:"ğŸ®" },
        { id:"snack-parfait", label:"ãƒ‘ãƒ•ã‚§", emoji:"ğŸ¨" },
        { id:"snack-pancake", label:"ãƒ›ãƒƒãƒˆã‚±ãƒ¼ã‚­", emoji:"ğŸ¥" },
        { id:"snack-choco", label:"ãƒãƒ§ã‚³", emoji:"ğŸ«" },
        { id:"snack-popcorn", label:"ãƒãƒƒãƒ—ã‚³ãƒ¼ãƒ³", emoji:"ğŸ¿" },
      ]},
      { id:"rule",   color:"#64b5f6", actions:[
        { id:"rule-uno", label:"ã‚«ãƒ¼ãƒ‰ã‚²ãƒ¼ãƒ ", emoji:"ğŸƒ" },
        { id:"rule-board", label:"ãƒœãƒ¼ãƒ‰ã‚²ãƒ¼ãƒ ", emoji:"ğŸ²" },
        { id:"rule-karuta", label:"ã‹ã‚‹ãŸ", emoji:"ğŸ€„ï¸" },
        { id:"rule-jenga", label:"ãƒãƒ©ãƒ³ã‚¹", emoji:"ğŸ§±" },
        { id:"rule-shiritori", label:"ã—ã‚Šã¨ã‚Š", emoji:"ğŸ—£ï¸" },
        { id:"rule-team", label:"ãƒãƒ¼ãƒ æˆ¦", emoji:"ğŸ¤" },
      ]},
      { id:"life",   color:"#aed581", actions:[
        { id:"life-clean", label:"æƒé™¤", emoji:"ğŸ§¹" },
        { id:"life-laundry", label:"æ´—æ¿¯", emoji:"ğŸ‘•" },
        { id:"life-money", label:"ãŠé‡‘", emoji:"ğŸ’´" },
        { id:"life-traffic", label:"äº¤é€š", emoji:"ğŸš¦" },
        { id:"life-manner", label:"ãƒãƒŠãƒ¼", emoji:"ğŸ™‡" },
        { id:"life-time", label:"æ™‚é–“", emoji:"â°" },
      ]},
      { id:"out",    color:"#90a4ae", actions:[
        { id:"out-park", label:"å…¬åœ’", emoji:"ğŸ›" },
        { id:"out-walk", label:"æ•£ç­–", emoji:"ğŸŒ¿" },
        { id:"out-library", label:"å›³æ›¸é¤¨", emoji:"ğŸ“š" },
        { id:"out-shop", label:"è²·ã„ç‰©", emoji:"ğŸ›’" },
        { id:"out-museum", label:"è¦‹å­¦", emoji:"ğŸ›ï¸" },
        { id:"out-train", label:"ä¹—ã‚Šç‰©", emoji:"ğŸšƒ" },
      ]},
    ];

    const ACTION_MAP = new Map();
    const GENRE_COLOR = new Map();
    for(const g of GENRES){
      GENRE_COLOR.set(g.id, g.color);
      for(const a of g.actions){
        ACTION_MAP.set(a.id, { label:a.label, emoji:a.emoji, genreId:g.id });
      }
    }

    // ===== ã‚¯ã‚¨ãƒª =====
    const params = new URLSearchParams(location.search);
    const y = Number(params.get("y")) || new Date().getFullYear();
    const m = Number(params.get("m")) || (new Date().getMonth()+1);
    document.getElementById("monthLabel").textContent = `${y}å¹´${m}æœˆ`;

    // ===== ãƒ‡ãƒ¼ã‚¿å–å¾—ï¼ˆlocalStorage or å…±æœ‰URLï¼‰ =====
    function keyOf(y,m){ return `kanakia_${y}-${String(m).padStart(2,"0")}`; }
    const storageKey = keyOf(y,m);
    let map = null;

    // 1) localStorageï¼ˆè‡ªåˆ†ã®ç«¯æœ«ï¼‰
    try{
      const raw = localStorage.getItem(storageKey);
      if(raw) map = JSON.parse(raw);
    }catch(e){}

    // 2) å…±æœ‰URLï¼ˆ#data=...ï¼‰
    // payload: { y, m, map }
    if(!map){
      const hash = location.hash || "";
      const match = hash.match(/data=([^&]+)/);
      if(match){
        try{
          const b64 = match[1].replace(/-/g,'+').replace(/_/g,'/');
          const json = decodeURIComponent(escape(atob(b64)));
          const payload = JSON.parse(json);
          if(payload && payload.map) map = payload.map;
        }catch(e){}
      }
    }

    if(!map){
      map = {};
      document.getElementById("subInfo").textContent = "ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ï¼ˆ2ãƒšãƒ¼ã‚¸ç›®ã§å…¥åŠ› â†’ ç¢ºèªã¸ï¼‰";
    }

    function pad2(n){ return String(n).padStart(2,"0"); }
    function isoDate(y,m,d){ return `${y}-${pad2(m)}-${pad2(d)}`; }

    // ===== ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼æç”» =====
    function buildCalendar(){
      const grid = document.getElementById("grid");
      grid.innerHTML = "";

      const first = new Date(y, m-1, 1);
      const last  = new Date(y, m, 0);
      const startDow = first.getDay();
      const daysInMonth = last.getDate();

      // å‰æœˆåŸ‹ã‚
      const prevLast = new Date(y, m-1, 0).getDate();
      for(let i=0;i<startDow;i++){
        const d = prevLast - (startDow-1-i);
        const cell = document.createElement("div");
        cell.className = "cell muted";
        cell.innerHTML = `<div class="date">${d}</div>`;
        grid.appendChild(cell);
      }

      // å½“æœˆ
      for(let d=1; d<=daysInMonth; d++){
        const key = isoDate(y,m,d);
        const saved = map[key]; // {genreId, actionId}
        let pillHtml = "";

        if(saved && saved.actionId){
          const act = ACTION_MAP.get(saved.actionId);
          const color = GENRE_COLOR.get(saved.genreId) || (act ? GENRE_COLOR.get(act.genreId) : "#e5e7eb");
          if(act){
            pillHtml = `
              <div class="pill" style="background:${color}">
                <div class="emoji">${act.emoji}</div>
                <div class="label">${act.label}</div>
              </div>
            `;
          }
        }

        const cell = document.createElement("div");
        cell.className = "cell";
        cell.innerHTML = `<div class="date">${d}</div>${pillHtml}`;
        grid.appendChild(cell);
      }

      // æ¬¡æœˆåŸ‹ã‚ï¼ˆ35 or 42ï¼‰
      const totalCellsSoFar = startDow + daysInMonth;
      const need = (totalCellsSoFar <= 35) ? (35 - totalCellsSoFar) : (42 - totalCellsSoFar);
      for(let i=1;i<=need;i++){
        const cell = document.createElement("div");
        cell.className = "cell muted";
        cell.innerHTML = `<div class="date">${i}</div>`;
        grid.appendChild(cell);
      }
    }

    // ===== å‡¡ä¾‹ï¼ˆä½¿ã£ã¦ã„ã‚‹ã‚‚ã®ã ã‘ï¼‰ =====
    function buildLegend(){
      const legend = document.getElementById("legend");
      legend.innerHTML = "";

      const used = new Map(); // actionId -> {label,emoji,color}
      for(const v of Object.values(map)){
        if(!v || !v.actionId || !v.genreId) continue;
        if(used.has(v.actionId)) continue;
        const act = ACTION_MAP.get(v.actionId);
        if(!act) continue;
        const color = GENRE_COLOR.get(v.genreId) || GENRE_COLOR.get(act.genreId) || "#e5e7eb";
        used.set(v.actionId, { ...act, color });
      }

      if(used.size === 0){
        legend.textContent = "â€» ã¾ã äºˆå®šãŒå…¥ã£ã¦ã„ã¾ã›ã‚“ã€‚";
        return;
      }

      for(const item of used.values()){
        const el = document.createElement("div");
        el.className = "dot";
        el.innerHTML = `<span class="sw" style="background:${item.color}"></span> ${item.emoji} ${item.label}`;
        legend.appendChild(el);
      }
    }

    buildCalendar();
    buildLegend();

    // ===== ãƒœã‚¿ãƒ³ =====
    function showToast(msg){
      const t = document.getElementById("toast");
      t.textContent = msg;
      t.classList.add("show");
      setTimeout(()=>t.classList.remove("show"), 1400);
    }

    // æˆ»ã‚‹ï¼ˆ2ãƒšãƒ¼ã‚¸ç›®ã¸ï¼‰
    document.getElementById("backBtn").addEventListener("click", ()=>{
      location.href = `action.html?y=${y}&m=${m}`;
    });

    // PDF
    document.getElementById("pdfBtn").addEventListener("click", ()=>{
      window.print();
    });

    // å…±æœ‰ï¼ˆç›¸æ‰‹ã®ç«¯æœ«ã§ã‚‚è¦‹ãˆã‚‹URLã‚’ä½œã‚‹ï¼‰
    document.getElementById("shareBtn").addEventListener("click", async ()=>{
      const payload = { y, m, map };
      const json = JSON.stringify(payload);
      const b64 = btoa(unescape(encodeURIComponent(json)))
        .replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,'');
      const shareUrl = `${location.origin}${location.pathname}?y=${y}&m=${m}#data=${b64}`;

      if(navigator.share){
        try{
          await navigator.share({
            title: `ã‚«ãƒŠãƒªã‚¢é€šä¿¡ ${y}å¹´${m}æœˆ`,
            text: `ã‚«ãƒŠãƒªã‚¢é€šä¿¡ï¼ˆ${y}å¹´${m}æœˆï¼‰ã§ã™ã€‚`,
            url: shareUrl
          });
          return;
        }catch(e){}
      }

      try{
        await navigator.clipboard.writeText(shareUrl);
        showToast("å…±æœ‰URLã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ");
      }catch(e){
        prompt("ã“ã®URLã‚’ã‚³ãƒ”ãƒ¼ã—ã¦å…±æœ‰ã—ã¦ãã ã•ã„", shareUrl);
      }
    });
  </script>
</body>
</html>
