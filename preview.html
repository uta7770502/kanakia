<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>é…å¸ƒç¢ºèª | ã‚«ãƒŠãƒªã‚¢é€šä¿¡</title>
  <style>
    :root{
      --bg:#f5f6f8;
      --card:#fff;
      --text:#1f2328;
      --muted:#6b7280;
      --line:#e5e7eb;
      --brand:#4fc3c7;
      --shadow: 0 10px 30px rgba(0,0,0,.08);
      --radius:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: -apple-system, BlinkMacSystemFont, "Noto Sans JP", "Hiragino Sans", "Helvetica Neue", Arial, sans-serif;
      background:var(--bg);
      color:var(--text);
    }

    /* ä¸Šéƒ¨ãƒãƒ¼ */
    .topbar{
      position:sticky; top:0; z-index:50;
      background:linear-gradient(180deg, rgba(79,195,199,.22), rgba(79,195,199,0));
      padding:12px 12px 8px;
      backdrop-filter: blur(6px);
    }
    .topbar-inner{
      max-width:920px;
      margin:0 auto;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .brand{
      display:flex; align-items:center; gap:10px;
      font-weight:800;
    }
    .badge{
      width:36px; height:36px; border-radius:12px;
      display:grid; place-items:center;
      background:#fff;
      box-shadow: var(--shadow);
      border:1px solid var(--line);
      font-size:20px;
    }
    .brand small{display:block; font-weight:600; color:var(--muted); margin-top:2px}

    .btns{display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end}
    .btn{
      appearance:none; border:1px solid var(--line);
      background:#fff;
      padding:10px 12px;
      border-radius:12px;
      font-weight:700;
      cursor:pointer;
      box-shadow: 0 6px 18px rgba(0,0,0,.06);
    }
    .btn.primary{
      background: linear-gradient(135deg, #2fbf71, #1ea85b);
      color:#fff;
      border:none;
    }
    .btn.ghost{
      background:#fff;
    }

    /* ãƒšãƒ¼ãƒ‘ãƒ¼ï¼ˆé…å¸ƒç”¨ã®1ãƒšãƒ¼ã‚¸ï¼‰ */
    .wrap{
      max-width:920px;
      margin:10px auto 80px;
      padding:0 12px;
    }
    .paper{
      background:var(--card);
      border:1px solid var(--line);
      border-radius: 22px;
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .paper-head{
      position:relative;
      padding:18px 18px 14px;
      background: linear-gradient(180deg, rgba(79,195,199,.28), rgba(79,195,199,.06));
      border-bottom:1px solid var(--line);
    }
    .paper-title{
      display:flex; align-items:flex-end; gap:10px;
      flex-wrap:wrap;
    }
    .paper-title h1{
      font-size:28px;
      letter-spacing:.02em;
      margin:0;
    }
    .paper-title .month{
      font-size:22px;
      font-weight:900;
    }
    .paper-sub{
      margin-top:10px;
      background:#fff;
      border:1px solid var(--line);
      border-radius:14px;
      padding:10px 12px;
      color:#0f766e;
      font-weight:700;
      display:flex;
      align-items:center;
      gap:8px;
    }
    .paper-sub span{
      display:inline-grid; place-items:center;
      width:28px; height:28px; border-radius:10px;
      background:rgba(79,195,199,.18);
      color:#0f766e;
      font-size:16px;
      border:1px solid rgba(79,195,199,.25);
    }

    /* ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ */
    .cal{
      padding:16px;
    }
    .cal-grid{
      display:grid;
      grid-template-columns: repeat(7, 1fr);
      gap:10px;
    }
    .dow{
      font-weight:900;
      color:var(--muted);
      text-align:center;
      font-size:13px;
      padding:6px 0;
    }
    .dow.sun{color:#ef4444}
    .dow.sat{color:#3b82f6}

    .cell{
      min-height:92px;
      border:1px solid var(--line);
      border-radius:16px;
      padding:10px 10px 8px;
      background:#fff;
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .cell.muted{
      opacity:.35;
      background:#fafafa;
    }
    .date{
      font-weight:900;
      font-size:14px;
      color:#111827;
    }

    .pill{
      margin-top:auto;
      border-radius:999px;
      padding:10px 12px;
      border:1px solid rgba(0,0,0,.06);
      display:flex;
      align-items:center;
      gap:10px;
      font-weight:900;
      line-height:1.1;
      min-height:46px;
      box-shadow: 0 8px 18px rgba(0,0,0,.08);
    }
    .pill .emoji{
      width:30px; height:30px;
      display:grid; place-items:center;
      border-radius:999px;
      background: rgba(255,255,255,.6);
      border:1px solid rgba(255,255,255,.55);
      font-size:18px;
    }
    .pill .label{
      flex:1;
      font-size:14px;
      word-break: keep-all;
    }

    .legend{
      border-top:1px dashed var(--line);
      padding:14px 16px;
      display:flex;
      flex-wrap:wrap;
      gap:8px 10px;
      align-items:center;
      color:var(--muted);
      font-weight:700;
      font-size:13px;
    }
    .legend .dot{
      display:inline-flex; align-items:center; gap:6px;
      padding:6px 10px;
      border:1px solid var(--line);
      border-radius:999px;
      background:#fff;
    }
    .legend .sw{
      width:12px; height:12px; border-radius:999px;
      border:1px solid rgba(0,0,0,.08);
      display:inline-block;
    }

    /* å…±æœ‰ã®å°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ */
    .toast{
      position:fixed;
      left:50%;
      transform:translateX(-50%);
      bottom:18px;
      background:#111827;
      color:#fff;
      padding:10px 12px;
      border-radius:12px;
      font-weight:800;
      box-shadow: 0 10px 30px rgba(0,0,0,.25);
      opacity:0;
      pointer-events:none;
      transition:.2s;
      max-width: calc(100vw - 24px);
      text-align:center;
    }
    .toast.show{opacity:1}

    /* å°åˆ·ï¼ˆPDFåŒ–ï¼‰ç”¨ */
    @media print{
      body{background:#fff}
      .topbar{display:none}
      .wrap{margin:0; padding:0}
      .paper{
        box-shadow:none;
        border:none;
        border-radius:0;
      }
      /* A4ã«è¿‘ã„ä½™ç™½ */
      @page { size: A4; margin: 10mm; }
    }
  </style>
  <div class="between-actions">
  <button id="previewBtn" class="previewBtn">é…å¸ƒç¢ºèªã¸</button>
</div>
</head>
<body>
  <div class="topbar">
    <div class="topbar-inner">
      <div class="brand">
        <div class="badge">ğŸ¤</div>
        <div>
          <div>ã‚«ãƒŠãƒªã‚¢é€šä¿¡ <span style="font-weight:900;">ï¼ˆé…å¸ƒç¢ºèªï¼‰</span></div>
          <small id="subInfo">URLå…±æœ‰ / PDFå‡ºåŠ›ã§ãã¾ã™</small>
        </div>
      </div>
      <div class="btns">
        <button class="btn ghost" id="backBtn">â† æˆ»ã‚‹</button>
        <button class="btn primary" id="pdfBtn">PDFã«ã™ã‚‹</button>
        <button class="btn" id="shareBtn">å…±æœ‰</button>
      </div>
    </div>
  </div>

  <div class="wrap">
    <div class="paper" id="paper">
      <div class="paper-head">
        <div class="paper-title">
          <h1>ã‚«ãƒŠãƒªã‚¢é€šä¿¡</h1>
          <div class="month" id="monthLabel">2025å¹´12æœˆ</div>
        </div>
        <div class="paper-sub">
          <span>ğŸ“£</span>
          <div>ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’ä½œæˆã—ã¾ã—ãŸï¼ã”å®¶åº­ã§ã®ç¢ºèªãƒ»æ²ç¤ºãƒ»å…±æœ‰ã«ã”åˆ©ç”¨ãã ã•ã„ã€‚</div>
        </div>
      </div>

      <div class="cal">
        <div class="cal-grid" id="dowRow">
          <div class="dow sun">æ—¥</div><div class="dow">æœˆ</div><div class="dow">ç«</div><div class="dow">æ°´</div><div class="dow">æœ¨</div><div class="dow">é‡‘</div><div class="dow sat">åœŸ</div>
        </div>
        <div class="cal-grid" id="grid"></div>
      </div>

      <div class="legend" id="legend"></div>
    </div>
  </div>

  <div class="toast" id="toast">ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ</div>

  <script>
    // ===== æ´»å‹•ãƒã‚¹ã‚¿ï¼ˆå¿…è¦ãªã‚‰å¥½ãã«è¿½åŠ OKï¼‰ =====
    // id: ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼å´ã®å€¤ / label: è¡¨ç¤º / emoji: ã‚¢ã‚¤ã‚³ãƒ³ / color: é…å¸ƒç”¨ã®è‰²
    const ACTIVITIES = [
      { id:"sport", label:"é‹å‹•", emoji:"ğŸƒ", color:"#93c5fd" },
      { id:"task", label:"æŒ‡å…ˆèª²é¡Œ", emoji:"âœ‹", color:"#a78bfa" },
      { id:"focus", label:"é›†ä¸­èª²é¡Œ", emoji:"ğŸ§ ", color:"#5eead4" },
      { id:"craft", label:"å·¥ä½œ", emoji:"ğŸ¨", color:"#fbbf24" },
      { id:"cook", label:"æ–™ç†", emoji:"ğŸ³", color:"#86efac" },
      { id:"snack", label:"ãŠã‚„ã¤ä½œã‚Š", emoji:"ğŸª", color:"#fdba74" },
      { id:"rule", label:"ãƒ«ãƒ¼ãƒ«ã‚²ãƒ¼ãƒ ", emoji:"ğŸ²", color:"#c4b5fd" },
      { id:"life", label:"ç”Ÿæ´»å­¦ç¿’", emoji:"ğŸ ", color:"#a3e635" },
      { id:"out", label:"å¤–å‡º", emoji:"ğŸšŒ", color:"#94a3b8" },
      { id:"off", label:"ãŠä¼‘ã¿", emoji:"ğŸ˜¶", color:"#e5e7eb" },
      // ä¾‹ï¼š2ãƒšãƒ¼ã‚¸ç›®ã§ä½¿ã£ã¦ãŸã‚„ã¤
      { id:"karaoke", label:"ã‚«ãƒ©ã‚ªã‚±", emoji:"ğŸ¤", color:"#fda4af" },
      { id:"planet", label:"ãƒ—ãƒ©ãƒã‚¿ãƒªã‚¦ãƒ ", emoji:"ğŸŒ™", color:"#7dd3fc" },
      { id:"study", label:"å­¦ç¿’", emoji:"ğŸ“š", color:"#86efac" },
      { id:"program", label:"ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°", emoji:"ğŸ¤–", color:"#d1d5db" },
    ];
    const ACT_MAP = new Map(ACTIVITIES.map(a => [a.id, a]));

    // ===== ã‚¯ã‚¨ãƒª =====
    const params = new URLSearchParams(location.search);
    const y = Number(params.get("y")) || new Date().getFullYear();
    const m = Number(params.get("m")) || (new Date().getMonth() + 1);

    document.getElementById("monthLabel").textContent = `${y}å¹´${m}æœˆ`;

    // ===== ãƒ‡ãƒ¼ã‚¿å–å¾—ï¼ˆlocalStorage or URLãƒãƒƒã‚·ãƒ¥ï¼‰ =====
    // ä¿å­˜ã‚­ãƒ¼ï¼ˆã“ã®æ–¹å¼ã«çµ±ä¸€ï¼‰
    const key = `kanakia_month_${y}-${String(m).padStart(2,"0")}`;
    let monthData = null;

    // 1) localStorage
    try{
      const raw = localStorage.getItem(key);
      if(raw) monthData = JSON.parse(raw);
    }catch(e){}

    // 2) URLãƒãƒƒã‚·ãƒ¥ (#data=...)
    if(!monthData){
      const hash = location.hash || "";
      const match = hash.match(/data=([^&]+)/);
      if(match){
        try{
          const json = decodeURIComponent(escape(atob(match[1].replace(/-/g,'+').replace(/_/g,'/'))));
          monthData = JSON.parse(json);
        }catch(e){}
      }
    }

    // monthData å½¢å¼:
    // { y:2025, m:12, assigns: { "2025-12-04": "sport", "2025-12-08":"planet" ... } }
    if(!monthData || !monthData.assigns){
      monthData = { y, m, assigns:{} };
      document.getElementById("subInfo").textContent = "ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ï¼ˆã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ç”»é¢ã§ä¿å­˜â†’ç¢ºèªã¸ï¼‰";
    }

    // ===== ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼æç”» =====
    function pad2(n){ return String(n).padStart(2,"0"); }
    function isoDate(y,m,d){ return `${y}-${pad2(m)}-${pad2(d)}`; }

    function buildCalendar(){
      const grid = document.getElementById("grid");
      grid.innerHTML = "";

      const first = new Date(y, m-1, 1);
      const last  = new Date(y, m, 0);
      const startDow = first.getDay(); // 0..6
      const daysInMonth = last.getDate();

      // å‰æœˆã®åŸ‹ã‚
      const prevLast = new Date(y, m-1, 0).getDate();
      for(let i=0;i<startDow;i++){
        const d = prevLast - (startDow-1-i);
        const cell = document.createElement("div");
        cell.className = "cell muted";
        cell.innerHTML = `<div class="date">${d}</div>`;
        grid.appendChild(cell);
      }

      // å½“æœˆ
      for(let d=1; d<=daysInMonth; d++){
        const dateKey = isoDate(y,m,d);
        const actId = monthData.assigns[dateKey];
        const act = actId ? ACT_MAP.get(actId) : null;

        const cell = document.createElement("div");
        cell.className = "cell";
        const pill = act ? `
          <div class="pill" style="background:${act.color}">
            <div class="emoji">${act.emoji || "âœ¨"}</div>
            <div class="label">${act.label}</div>
          </div>
        ` : "";

        cell.innerHTML = `<div class="date">${d}</div>${pill}`;
        grid.appendChild(cell);
      }

      // æ¬¡æœˆã®åŸ‹ã‚ï¼ˆ6è¡Œå›ºå®šã«è¿‘ã¥ã‘ã‚‹ï¼‰
      const totalCellsSoFar = startDow + daysInMonth;
      const need = (totalCellsSoFar <= 35) ? (35 - totalCellsSoFar) : (42 - totalCellsSoFar);
      for(let i=1;i<=need;i++){
        const cell = document.createElement("div");
        cell.className = "cell muted";
        cell.innerHTML = `<div class="date">${i}</div>`;
        grid.appendChild(cell);
      }
    }

    // ===== å‡¡ä¾‹ =====
    function buildLegend(){
      const legend = document.getElementById("legend");
      legend.innerHTML = "";

      // ä½¿ã£ã¦ã„ã‚‹ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã ã‘æŠ½å‡º
      const used = new Set(Object.values(monthData.assigns || {}).filter(Boolean));
      if(used.size === 0){
        legend.textContent = "â€» ã¾ã äºˆå®šãŒå…¥ã£ã¦ã„ã¾ã›ã‚“ã€‚";
        return;
      }

      for(const id of used){
        const act = ACT_MAP.get(id);
        if(!act) continue;
        const el = document.createElement("div");
        el.className = "dot";
        el.innerHTML = `<span class="sw" style="background:${act.color}"></span> ${act.emoji} ${act.label}`;
        legend.appendChild(el);
      }
    }

    buildCalendar();
    buildLegend();

    // ===== ãƒœã‚¿ãƒ³å‹•ä½œ =====
    const toast = (msg)=>{
      const t = document.getElementById("toast");
      t.textContent = msg;
      t.classList.add("show");
      setTimeout(()=>t.classList.remove("show"), 1400);
    };

    // æˆ»ã‚‹ï¼ˆaction.htmlã«æˆ»ã™ï¼‰
    document.getElementById("backBtn").addEventListener("click", ()=>{
      // action.html å´ãŒ y,m ã‚’å—ã‘å–ã‚Œã‚‹æƒ³å®š
      location.href = `action.html?y=${y}&m=${m}`;
    });

    // PDFï¼ˆ=å°åˆ·ï¼‰
    document.getElementById("pdfBtn").addEventListener("click", ()=>{
      window.print();
    });

    // å…±æœ‰
    document.getElementById("shareBtn").addEventListener("click", async ()=>{
      // å…±æœ‰URLï¼šlocalStorageä¾å­˜ã ã¨ç›¸æ‰‹ã®ç«¯æœ«ã§è¦‹ãˆãªã„ã®ã§ã€
      // URLã«ãƒ‡ãƒ¼ã‚¿ã‚’è©°ã‚ãŸãƒªãƒ³ã‚¯ã‚’ç”Ÿæˆã—ã¦æ¸¡ã™ï¼ˆãƒãƒƒã‚·ãƒ¥ã«å…¥ã‚Œã‚‹ï¼‰
      const payload = {
        y, m,
        assigns: monthData.assigns || {}
      };
      const json = JSON.stringify(payload);
      const b64 = btoa(unescape(encodeURIComponent(json)))
        .replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,'');
      const shareUrl = `${location.origin}${location.pathname}?y=${y}&m=${m}#data=${b64}`;

      // Web Share APIï¼ˆiPhone/Androidã§LINEã‚„ãƒ¡ãƒ¼ãƒ«ãŒå‡ºã‚‹ï¼‰
      if(navigator.share){
        try{
          await navigator.share({
            title: `ã‚«ãƒŠãƒªã‚¢é€šä¿¡ ${y}å¹´${m}æœˆ`,
            text: `ã‚«ãƒŠãƒªã‚¢é€šä¿¡ï¼ˆ${y}å¹´${m}æœˆï¼‰ã§ã™ã€‚`,
            url: shareUrl
          });
          return;
        }catch(e){
          // ã‚­ãƒ£ãƒ³ã‚»ãƒ«ç­‰ã¯ä½•ã‚‚ã—ãªã„
        }
      }

      // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼šã‚³ãƒ”ãƒ¼
      try{
        await navigator.clipboard.writeText(shareUrl);
        toast("å…±æœ‰URLã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ");
      }catch(e){
        prompt("ã“ã®URLã‚’ã‚³ãƒ”ãƒ¼ã—ã¦å…±æœ‰ã—ã¦ãã ã•ã„", shareUrl);
      }
    });
  </script>
</body>
</html>
