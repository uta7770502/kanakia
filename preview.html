<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>é…å¸ƒç¢ºèª | ã‚«ãƒŠãƒªã‚¢é€šä¿¡</title>

  <style>
    :root{
      --bg:#f5f6f8;
      --paper:#fff;
      --text:#111827;
      --muted:#6b7280;
      --line:#e5e7eb;
      --brand:#4fc3c7;
      --shadow: 0 12px 30px rgba(0,0,0,.10);
      --radius:18px;

      /* A4å‘ã‘ã®è¦‹ã‚„ã™ã• */
      --cellH: 108px;          /* 1ãƒã‚¹é«˜ã•ï¼ˆA4ã§è¦‹ã‚„ã™ãï¼‰ */
      --gap: 8px;              /* ãƒã‚¹é–“éš” */
      --dateSize: 15px;        /* æ—¥ä»˜æ–‡å­—ã‚µã‚¤ã‚º */
      --labelSize: 15px;       /* ãƒ©ãƒ™ãƒ«æ–‡å­—ã‚µã‚¤ã‚º */
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:-apple-system,BlinkMacSystemFont,"Noto Sans JP","Hiragino Sans","Helvetica Neue",Arial,sans-serif;
      background:var(--bg);
      color:var(--text);
    }

    /* ===== ä¸Šéƒ¨ãƒãƒ¼ï¼ˆç”»é¢ç”¨ï¼šå°åˆ·æ™‚ã¯éè¡¨ç¤ºï¼‰ ===== */
    .topbar{
      position:sticky; top:0; z-index:50;
      background:linear-gradient(180deg, rgba(79,195,199,.22), rgba(79,195,199,0));
      backdrop-filter: blur(6px);
      padding:12px 12px 10px;
    }
    .topbar-inner{
      max-width:980px;
      margin:0 auto;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .brand{
      display:flex; align-items:center; gap:10px;
      font-weight:900;
    }
    .badge{
      width:38px; height:38px; border-radius:14px;
      display:grid; place-items:center;
      background:#fff;
      border:1px solid var(--line);
      box-shadow: var(--shadow);
      font-size:20px;
      flex:0 0 auto;
    }
    .brand small{
      display:block;
      font-weight:700;
      color:var(--muted);
      margin-top:2px;
    }
    .btns{display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end}
    .btn{
      appearance:none;
      border:1px solid var(--line);
      background:#fff;
      padding:10px 12px;
      border-radius:12px;
      font-weight:900;
      cursor:pointer;
      box-shadow: 0 6px 18px rgba(0,0,0,.08);
    }
    .btn.primary{
      background: linear-gradient(135deg, #2fbf71, #1ea85b);
      color:#fff;
      border:none;
    }

    /* ===== A4ç´™é¢ï¼ˆãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æœ¬ä½“ï¼‰ ===== */
    .wrap{
      max-width:980px;
      margin:12px auto 80px;
      padding:0 12px;
    }

    /* A4ç´™é¢ã£ã½ã„è¦‹ãŸç›® */
    .paper{
      background:var(--paper);
      border:1px solid var(--line);
      border-radius: 22px;
      box-shadow: var(--shadow);
      overflow:hidden;
    }

    /* è¦‹å‡ºã—ï¼ˆå³ç”»åƒã¿ãŸã„ã«ã€Œã‚¿ã‚¤ãƒˆãƒ«ï¼‹æœˆã€ï¼‰ */
    .paper-head{
      padding:18px 18px 12px;
      border-bottom:1px solid var(--line);
      background:
        radial-gradient(1000px 180px at 20% 0%, rgba(79,195,199,.22), transparent 60%),
        radial-gradient(900px 160px at 80% 0%, rgba(47,191,113,.14), transparent 60%),
        linear-gradient(180deg, rgba(79,195,199,.16), rgba(79,195,199,.03));
    }
    .title-row{
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
    }
    .h1{
      display:flex;
      align-items:flex-end;
      gap:10px;
      flex-wrap:wrap;
    }
    .h1 .logo{
      font-size:34px;
      line-height:1;
    }
    .h1 h1{
      margin:0;
      font-size:30px;
      letter-spacing:.02em;
      font-weight:1000;
    }
    .month{
      font-size:22px;
      font-weight:1000;
      color:#0f766e;
      padding:6px 10px;
      border-radius:14px;
      background:#fff;
      border:1px solid rgba(79,195,199,.28);
    }

    .desc{
      margin-top:10px;
      background:#fff;
      border:1px solid var(--line);
      border-radius:14px;
      padding:10px 12px;
      color:#0f766e;
      font-weight:900;
      display:flex;
      align-items:center;
      gap:10px;
    }
    .desc .icon{
      width:30px; height:30px;
      border-radius:12px;
      display:grid; place-items:center;
      background:rgba(79,195,199,.18);
      border:1px solid rgba(79,195,199,.25);
      font-size:18px;
      flex:0 0 auto;
    }

    /* ===== ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ ===== */
    .cal{
      padding:14px 16px 16px;
    }

    .dow-row{
      display:grid;
      grid-template-columns: repeat(7, 1fr);
      gap: var(--gap);
      margin-bottom: var(--gap);
    }
    .dow{
      text-align:center;
      font-weight:1000;
      color:var(--muted);
      font-size:13px;
      padding:6px 0;
    }
    .dow.sun{color:#ef4444}
    .dow.sat{color:#3b82f6}

    .grid{
      display:grid;
      grid-template-columns: repeat(7, 1fr);
      gap: var(--gap);
    }

    .cell{
      min-height: var(--cellH);
      border:1px solid var(--line);
      border-radius:16px;
      padding:10px 10px 8px;
      background:#fff;
      display:flex;
      flex-direction:column;
      position:relative;
      overflow:hidden;
    }
    .cell.muted{
      background:#fafafa;
      opacity:.35;
    }
    .date{
      font-weight:1000;
      font-size: var(--dateSize);
      color:#111827;
      line-height:1;
    }

    /* å³ç”»åƒã£ã½ã„ï¼šä¸‹ã«å¤§ãã‚ãƒ©ãƒ™ãƒ« */
    .label-pill{
      margin-top:auto;
      border-radius: 999px;
      padding:10px 12px;
      border:1px solid rgba(0,0,0,.06);
      display:flex;
      align-items:center;
      gap:10px;
      font-weight:1000;
      min-height:48px;
      box-shadow: 0 10px 18px rgba(0,0,0,.10);
    }
    .label-pill .emo{
      width:32px; height:32px;
      border-radius:999px;
      display:grid; place-items:center;
      background: rgba(255,255,255,.65);
      border:1px solid rgba(255,255,255,.55);
      font-size:18px;
      flex:0 0 auto;
    }
    .label-pill .txt{
      font-size: var(--labelSize);
      line-height:1.1;
      color:#0b1220;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      flex:1;
    }

    /* ===== å‡¡ä¾‹ ===== */
    .legend{
      border-top:1px dashed var(--line);
      padding:12px 16px 14px;
      display:flex;
      flex-wrap:wrap;
      gap:8px 10px;
      align-items:center;
      color:var(--muted);
      font-weight:900;
      font-size:13px;
    }
    .legend .dot{
      display:inline-flex; align-items:center; gap:8px;
      padding:7px 10px;
      border:1px solid var(--line);
      border-radius:999px;
      background:#fff;
    }
    .legend .sw{
      width:12px; height:12px; border-radius:999px;
      border:1px solid rgba(0,0,0,.08);
      display:inline-block;
    }

    /* ===== ãƒˆãƒ¼ã‚¹ãƒˆ ===== */
    .toast{
      position:fixed;
      left:50%;
      transform:translateX(-50%);
      bottom:18px;
      background:#111827;
      color:#fff;
      padding:10px 12px;
      border-radius:12px;
      font-weight:1000;
      box-shadow: 0 12px 30px rgba(0,0,0,.25);
      opacity:0;
      pointer-events:none;
      transition:.2s;
      max-width: calc(100vw - 24px);
      text-align:center;
      z-index:999;
    }
    .toast.show{opacity:1}

    /* ===== å°åˆ·ï¼ˆPDFåŒ–ï¼‰ ===== */
    @media print{
      body{background:#fff}
      .topbar{display:none !important}
      .wrap{margin:0; padding:0}
      .paper{
        box-shadow:none;
        border:none;
        border-radius:0;
      }
      /* A4 ä½™ç™½ */
      @page { size: A4; margin: 10mm; }

      /* å°åˆ·ã§ã¯å°‘ã—è©°ã‚ã‚‹ï¼ˆã¯ã¿å‡ºã—é˜²æ­¢ï¼‰ */
      :root{
        --cellH: 100px;
        --gap: 7px;
        --dateSize: 14px;
        --labelSize: 14px;
      }
    }

    /* å°ã•ã„ã‚¹ãƒãƒ›ã§ã¯ ã¡ã‚‡ã„èª¿æ•´ */
    @media (max-width:420px){
      :root{
        --cellH: 96px;
        --gap: 7px;
        --labelSize: 14px;
      }
      .h1 h1{font-size:26px}
      .month{font-size:18px}
    }
  </style>
</head>

<body>
  <!-- ç”»é¢ä¸Šéƒ¨ï¼ˆæ“ä½œãƒœã‚¿ãƒ³ï¼‰ -->
  <div class="topbar">
    <div class="topbar-inner">
      <div class="brand">
        <div class="badge">ğŸ¤</div>
        <div>
          <div>ã‚«ãƒŠãƒªã‚¢é€šä¿¡ <span style="font-weight:1000;">ï¼ˆé…å¸ƒç¢ºèªï¼‰</span></div>
          <small id="subInfo">å®Œæˆç‰ˆã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ï¼ˆPDF / å…±æœ‰ï¼‰</small>
        </div>
      </div>
      <div class="btns">
        <button class="btn" id="backBtn">â† æˆ»ã‚‹</button>
        <button class="btn primary" id="pdfBtn">PDFã«ã™ã‚‹</button>
        <button class="btn" id="shareBtn">å…±æœ‰</button>
      </div>
    </div>
  </div>

  <!-- A4ç´™é¢ -->
  <div class="wrap">
    <div class="paper" id="paper">
      <div class="paper-head">
        <div class="title-row">
          <div class="h1">
            <div class="logo">ğŸ¤</div>
            <h1>ã‚«ãƒŠãƒªã‚¢é€šä¿¡</h1>
          </div>
          <div class="month" id="monthLabel">2025å¹´12æœˆ</div>
        </div>

        <div class="desc">
          <div class="icon">ğŸ“£</div>
          <div>å®Œæˆç‰ˆã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã§ã™ã€‚ã”å®¶åº­ã§ã®ç¢ºèªãƒ»æ²ç¤ºãƒ»å…±æœ‰ã«ã”åˆ©ç”¨ãã ã•ã„ã€‚</div>
        </div>
      </div>

      <div class="cal">
        <div class="dow-row">
          <div class="dow sun">æ—¥</div><div class="dow">æœˆ</div><div class="dow">ç«</div><div class="dow">æ°´</div><div class="dow">æœ¨</div><div class="dow">é‡‘</div><div class="dow sat">åœŸ</div>
        </div>
        <div class="grid" id="grid"></div>
      </div>

      <div class="legend" id="legend"></div>
    </div>
  </div>

  <div class="toast" id="toast">ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ</div>

  <script>
    /* =======================================================
      2ãƒšãƒ¼ã‚¸ç›®ã®ä¿å­˜å½¢å¼:
        key:  kanakia_YYYY-MM  (ä¾‹: kanakia_2025-12)
        val:  { "YYYY-MM-DD": {genreId:"craft", actionId:"craft-season"} , ... }

      ã“ã® preview.html ã¯ãã‚Œã‚’èª­ã¿è¾¼ã¿ â†’ A4å‘ã‘ã«æç”»ã—ã¾ã™
      ã•ã‚‰ã«å…±æœ‰ã§ã¯ã€ãƒ‡ãƒ¼ã‚¿å…¥ã‚ŠURL(#data=...) ã‚’ç”Ÿæˆã—ã¦ç›¸æ‰‹ã«æ¸¡ã—ã¾ã™
    ======================================================= */

    // ===== 2ãƒšãƒ¼ã‚¸ç›®ã¨åŒã˜GENRESï¼ˆè¡¨ç¤ºã«å¿…è¦ãªæœ€ä½é™ï¼‰ =====
    const GENRES = [
      { id:"sport",  label:"é‹å‹•",     emoji:"ğŸƒ", color:"#93c5fd",
        actions:[
          { id:"sport-run",   label:"ã‹ã‘ã£ã“", emoji:"ğŸƒâ€â™‚ï¸" },
          { id:"sport-ball",  label:"ãƒœãƒ¼ãƒ«éŠã³", emoji:"âš½ï¸" },
          { id:"sport-dance", label:"ãƒ€ãƒ³ã‚¹", emoji:"ğŸ’ƒ" },
          { id:"sport-gym",   label:"ã‚µãƒ¼ã‚­ãƒƒãƒˆ", emoji:"ğŸ¤¸" },
          { id:"sport-walk",  label:"æ•£æ­©", emoji:"ğŸš¶" },
          { id:"sport-game",  label:"é‹å‹•ã‚²ãƒ¼ãƒ ", emoji:"ğŸ¸" },
        ]},
      { id:"finger", label:"æŒ‡å…ˆèª²é¡Œ", emoji:"âœ‹", color:"#a78bfa",
        actions:[
          { id:"finger-cut",  label:"ã¯ã•ã¿", emoji:"âœ‚ï¸" },
          { id:"finger-fold", label:"æŠ˜ã‚Šç´™", emoji:"ğŸ“„" },
          { id:"finger-bead", label:"ã²ã‚‚é€šã—", emoji:"ğŸ§µ" },
          { id:"finger-peg",  label:"æ´—æ¿¯ã°ã•ã¿", emoji:"ğŸ“" },
          { id:"finger-clay", label:"ç²˜åœŸ", emoji:"ğŸ§±" },
          { id:"finger-puzzle",label:"ãƒ‘ã‚ºãƒ«", emoji:"ğŸ§©" },
        ]},
      { id:"focus",  label:"é›†ä¸­èª²é¡Œ", emoji:"ğŸ§ ", color:"#5eead4",
        actions:[
          { id:"focus-worksheet", label:"ãƒ¯ãƒ¼ã‚¯", emoji:"ğŸ“" },
          { id:"focus-maze",      label:"è¿·è·¯", emoji:"ğŸŒ€" },
          { id:"focus-math",      label:"æ•°ã‚ãã³", emoji:"ğŸ”¢" },
          { id:"focus-letter",    label:"ã“ã¨ã°", emoji:"ğŸ”¤" },
          { id:"focus-memory",    label:"è¨˜æ†¶ã‚²ãƒ¼ãƒ ", emoji:"ğŸ§ " },
          { id:"focus-time",      label:"æ™‚è¨ˆ", emoji:"ğŸ•’" },
        ]},
      { id:"craft",  label:"å·¥ä½œ",     emoji:"ğŸ¨", color:"#fbbf24",
        actions:[
          { id:"craft-paint",  label:"ã¬ã‚Šçµµ", emoji:"ğŸ–ï¸" },
          { id:"craft-paper",  label:"ç´™å·¥ä½œ", emoji:"ğŸ“" },
          { id:"craft-season", label:"å­£ç¯€åˆ¶ä½œ", emoji:"ğŸ" },
          { id:"craft-collage",label:"ã‚³ãƒ©ãƒ¼ã‚¸ãƒ¥", emoji:"ğŸ“°" },
          { id:"craft-mask",   label:"ãŠé¢", emoji:"ğŸ­" },
          { id:"craft-card",   label:"ã‚«ãƒ¼ãƒ‰ä½œã‚Š", emoji:"ğŸ’Œ" },
        ]},
      { id:"cook",   label:"æ–™ç†",     emoji:"ğŸ³", color:"#86efac",
        actions:[
          { id:"cook-sand",  label:"ã‚µãƒ³ãƒ‰", emoji:"ğŸ¥ª" },
          { id:"cook-salad", label:"ã‚µãƒ©ãƒ€", emoji:"ğŸ¥—" },
          { id:"cook-onigiri",label:"ãŠã«ãã‚Š", emoji:"ğŸ™" },
          { id:"cook-soup",  label:"ã‚¹ãƒ¼ãƒ—", emoji:"ğŸ²" },
          { id:"cook-egg",   label:"ãŸã¾ã”", emoji:"ğŸ³" },
          { id:"cook-fruit", label:"ãƒ•ãƒ«ãƒ¼ãƒ„", emoji:"ğŸ" },
        ]},
      { id:"snack",  label:"ãŠã‚„ã¤ä½œã‚Š", emoji:"ğŸª", color:"#fdba74",
        actions:[
          { id:"snack-cookie", label:"ã‚¯ãƒƒã‚­ãƒ¼", emoji:"ğŸª" },
          { id:"snack-jelly",  label:"ã‚¼ãƒªãƒ¼", emoji:"ğŸ®" },
          { id:"snack-parfait",label:"ãƒ‘ãƒ•ã‚§", emoji:"ğŸ¨" },
          { id:"snack-pancake",label:"ãƒ›ãƒƒãƒˆã‚±ãƒ¼ã‚­", emoji:"ğŸ¥" },
          { id:"snack-choco",  label:"ãƒãƒ§ã‚³", emoji:"ğŸ«" },
          { id:"snack-popcorn",label:"ãƒãƒƒãƒ—ã‚³ãƒ¼ãƒ³", emoji:"ğŸ¿" },
        ]},
      { id:"rule",   label:"ãƒ«ãƒ¼ãƒ«ã‚²ãƒ¼ãƒ ", emoji:"ğŸ²", color:"#c4b5fd",
        actions:[
          { id:"rule-uno",    label:"ã‚«ãƒ¼ãƒ‰ã‚²ãƒ¼ãƒ ", emoji:"ğŸƒ" },
          { id:"rule-board",  label:"ãƒœãƒ¼ãƒ‰ã‚²ãƒ¼ãƒ ", emoji:"ğŸ²" },
          { id:"rule-karuta", label:"ã‹ã‚‹ãŸ", emoji:"ğŸ€„ï¸" },
          { id:"rule-jenga",  label:"ãƒãƒ©ãƒ³ã‚¹", emoji:"ğŸ§±" },
          { id:"rule-shiritori",label:"ã—ã‚Šã¨ã‚Š", emoji:"ğŸ—£ï¸" },
          { id:"rule-team",   label:"ãƒãƒ¼ãƒ æˆ¦", emoji:"ğŸ¤" },
        ]},
      { id:"life",   label:"ç”Ÿæ´»å­¦ç¿’", emoji:"ğŸ ", color:"#a3e635",
        actions:[
          { id:"life-clean",  label:"æƒé™¤", emoji:"ğŸ§¹" },
          { id:"life-laundry",label:"æ´—æ¿¯", emoji:"ğŸ‘•" },
          { id:"life-money",  label:"ãŠé‡‘", emoji:"ğŸ’´" },
          { id:"life-traffic",label:"äº¤é€š", emoji:"ğŸš¦" },
          { id:"life-manner", label:"ãƒãƒŠãƒ¼", emoji:"ğŸ™‡" },
          { id:"life-time",   label:"æ™‚é–“", emoji:"â°" },
        ]},
      { id:"out",    label:"å¤–å‡º",     emoji:"ğŸšŒ", color:"#94a3b8",
        actions:[
          { id:"out-park",   label:"å…¬åœ’", emoji:"ğŸ›" },
          { id:"out-walk",   label:"æ•£ç­–", emoji:"ğŸŒ¿" },
          { id:"out-library",label:"å›³æ›¸é¤¨", emoji:"ğŸ“š" },
          { id:"out-shop",   label:"è²·ã„ç‰©", emoji:"ğŸ›’" },
          { id:"out-museum", label:"è¦‹å­¦", emoji:"ğŸ›ï¸" },
          { id:"out-train",  label:"ä¹—ã‚Šç‰©", emoji:"ğŸšƒ" },
        ]},
    ];
    const genreById = Object.fromEntries(GENRES.map(g => [g.id, g]));

    function findAction(genreId, actionId){
      const g = genreById[genreId];
      if(!g) return null;
      const a = g.actions.find(x => x.id === actionId);
      if(!a) return null;
      return { genre:g, action:a };
    }

    // ===== ã‚¯ã‚¨ãƒªï¼ˆ2ãƒšãƒ¼ã‚¸ç›®ã‹ã‚‰ y,m ã‚’æ¸¡ã™ï¼‰ =====
    const params = new URLSearchParams(location.search);
    const y = Number(params.get("y")) || new Date().getFullYear();
    const m = Number(params.get("m")) || (new Date().getMonth() + 1);
    document.getElementById("monthLabel").textContent = `${y}å¹´${m}æœˆ`;

    // ===== ãƒ‡ãƒ¼ã‚¿å–å¾—ï¼š1) localStorage 2) URLãƒãƒƒã‚·ãƒ¥(#data=...) =====
    const storageKey = `kanakia_${y}-${String(m).padStart(2,"0")}`;
    let monthMap = null;

    // localStorage
    try{
      const raw = localStorage.getItem(storageKey);
      if(raw) monthMap = JSON.parse(raw);
    }catch(e){}

    // URLãƒãƒƒã‚·ãƒ¥
    if(!monthMap){
      const hash = location.hash || "";
      const match = hash.match(/data=([^&]+)/);
      if(match){
        try{
          const b64 = match[1].replace(/-/g,'+').replace(/_/g,'/');
          const json = decodeURIComponent(escape(atob(b64)));
          const payload = JSON.parse(json);
          // payload.map ã‚’æœŸå¾…
          if(payload && payload.map) monthMap = payload.map;
          // y,m ã‚‚ payload ã‹ã‚‰æ¥ãŸã‚‰ä¸Šæ›¸ãè¡¨ç¤ºï¼ˆå¿µã®ãŸã‚ï¼‰
          if(payload && payload.y && payload.m){
            document.getElementById("monthLabel").textContent = `${payload.y}å¹´${payload.m}æœˆ`;
          }
        }catch(e){}
      }
    }

    if(!monthMap){
      monthMap = {};
      document.getElementById("subInfo").textContent = "ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ï¼ˆ2ãƒšãƒ¼ã‚¸ç›®ã§å…¥åŠ›å¾Œã€é…å¸ƒç¢ºèªã¸ï¼‰";
    }

    // ===== ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼æç”» =====
    const pad2 = (n)=> String(n).padStart(2,"0");
    const isoDate = (yy,mm,dd)=> `${yy}-${pad2(mm)}-${pad2(dd)}`;

    function buildCalendar(){
      const grid = document.getElementById("grid");
      grid.innerHTML = "";

      const first = new Date(y, m-1, 1);
      const last  = new Date(y, m, 0);
      const startDow = first.getDay();   // 0..6
      const daysInMonth = last.getDate();

      // å‰æœˆã®åŸ‹ã‚
      const prevLast = new Date(y, m-1, 0).getDate();
      for(let i=0;i<startDow;i++){
        const d = prevLast - (startDow-1-i);
        const cell = document.createElement("div");
        cell.className = "cell muted";
        cell.innerHTML = `<div class="date">${d}</div>`;
        grid.appendChild(cell);
      }

      // å½“æœˆ
      for(let d=1; d<=daysInMonth; d++){
        const dateKey = isoDate(y,m,d);
        const saved = monthMap[dateKey]; // {genreId, actionId} ã‚’æƒ³å®š
        const cell = document.createElement("div");
        cell.className = "cell";
        let pillHTML = "";

        if(saved && saved.genreId && saved.actionId){
          const found = findAction(saved.genreId, saved.actionId);
          if(found){
            const g = found.genre;
            const a = found.action;
            pillHTML = `
              <div class="label-pill" style="background:${g.color}">
                <div class="emo">${a.emoji || g.emoji || "âœ¨"}</div>
                <div class="txt">${a.label}</div>
              </div>
            `;
          }
        }

        cell.innerHTML = `<div class="date">${d}</div>${pillHTML}`;
        grid.appendChild(cell);
      }

      // æ¬¡æœˆã®åŸ‹ã‚ï¼ˆ5é€± or 6é€±ï¼‰
      const totalCellsSoFar = startDow + daysInMonth;
      const need = (totalCellsSoFar <= 35) ? (35 - totalCellsSoFar) : (42 - totalCellsSoFar);
      for(let i=1;i<=need;i++){
        const cell = document.createElement("div");
        cell.className = "cell muted";
        cell.innerHTML = `<div class="date">${i}</div>`;
        grid.appendChild(cell);
      }
    }

    // ===== å‡¡ä¾‹ï¼ˆä½¿ã‚ã‚Œã¦ã„ã‚‹ã‚¸ãƒ£ãƒ³ãƒ«ã ã‘ï¼‰ =====
    function buildLegend(){
      const legend = document.getElementById("legend");
      legend.innerHTML = "";

      const usedGenreIds = new Set();
      Object.values(monthMap || {}).forEach(v=>{
        if(v && v.genreId) usedGenreIds.add(v.genreId);
      });

      if(usedGenreIds.size === 0){
        legend.textContent = "â€» ã¾ã äºˆå®šãŒå…¥ã£ã¦ã„ã¾ã›ã‚“ã€‚";
        return;
      }

      // 2ãƒšãƒ¼ã‚¸ç›®ã®ä¸¦ã³é †ã§å‡ºã™
      GENRES.forEach(g=>{
        if(!usedGenreIds.has(g.id)) return;
        const el = document.createElement("div");
        el.className = "dot";
        el.innerHTML = `<span class="sw" style="background:${g.color}"></span> ${g.emoji} ${g.label}`;
        legend.appendChild(el);
      });
    }

    buildCalendar();
    buildLegend();

    // ===== ãƒœã‚¿ãƒ³ =====
    const toast = (msg)=>{
      const t = document.getElementById("toast");
      t.textContent = msg;
      t.classList.add("show");
      setTimeout(()=>t.classList.remove("show"), 1400);
    };

    document.getElementById("backBtn").addEventListener("click", ()=>{
      location.href = `action.html?y=${y}&m=${m}`;
    });

    document.getElementById("pdfBtn").addEventListener("click", ()=>{
      window.print();
    });

    document.getElementById("shareBtn").addEventListener("click", async ()=>{
      // ãƒ‡ãƒ¼ã‚¿å…¥ã‚ŠURLç”Ÿæˆï¼ˆç›¸æ‰‹ã®ç«¯æœ«ã§ã‚‚è¡¨ç¤ºã§ãã‚‹ï¼‰
      const payload = { y, m, map: monthMap };
      const json = JSON.stringify(payload);
      const b64 = btoa(unescape(encodeURIComponent(json)))
        .replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,'');

      const shareUrl = `${location.origin}${location.pathname}?y=${y}&m=${m}#data=${b64}`;

      if(navigator.share){
        try{
          await navigator.share({
            title: `ã‚«ãƒŠãƒªã‚¢é€šä¿¡ ${y}å¹´${m}æœˆ`,
            text: `ã‚«ãƒŠãƒªã‚¢é€šä¿¡ï¼ˆ${y}å¹´${m}æœˆï¼‰ã®ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã§ã™ã€‚`,
            url: shareUrl
          });
          return;
        }catch(e){}
      }

      // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼šã‚³ãƒ”ãƒ¼
      try{
        await navigator.clipboard.writeText(shareUrl);
        toast("å…±æœ‰URLã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ");
      }catch(e){
        prompt("ã“ã®URLã‚’ã‚³ãƒ”ãƒ¼ã—ã¦å…±æœ‰ã—ã¦ãã ã•ã„", shareUrl);
      }
    });
  </script>
</body>
</html>
