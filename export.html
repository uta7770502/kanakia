<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>é…å¸ƒç”¨PDFï½œã‚«ãƒŠãƒªã‚¢é€šä¿¡</title>

  <style>
    /* ===== A4å°åˆ·è¨­å®š ===== */
    @page { size: A4; margin: 10mm; }

    :root{
      --text:#1a1a1a;
      --muted:#6b7280;
      --line:#e5e7eb;
      --accent:#16a34a;
      --bg:#f7f7fb;
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, "Hiragino Kaku Gothic ProN", "Noto Sans JP", "Yu Gothic", sans-serif;
      color: var(--text);
      background: linear-gradient(180deg, #ffffff, var(--bg));
    }

    /* ===== ç”»é¢ä¸Šã®ãƒ„ãƒ¼ãƒ«ãƒãƒ¼ï¼ˆPDFåŒ–æ™‚ã¯æ¶ˆãˆã‚‹ï¼‰ ===== */
    .toolbar{
      position: sticky;
      top: 0;
      z-index: 10;
      background:#fff;
      border-bottom:1px solid var(--line);
      padding:10px 12px;
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
      flex-wrap:wrap;
    }
    .toolbar .left{
      display:flex; gap:10px; align-items:center; flex-wrap:wrap;
    }
    .toolbar strong{ font-weight: 900; }
    .toolbar small{ color: var(--muted); }

    .toolbar button{
      border: 1px solid var(--line);
      background: #fff;
      color: #111;
      padding: 10px 12px;
      border-radius: 12px;
      font-size: 14px;
      font-weight: 800;
      cursor: pointer;
    }
    .toolbar button.primary{
      background: var(--accent);
      color:#fff;
      border-color: transparent;
    }

    @media print{
      body{ background:#fff; }
      .toolbar{ display:none; }
    }

    /* ===== é…å¸ƒç‰©ï¼ˆç´™ï¼‰ ===== */
    .paper{
      position: relative;
      width: 190mm;                 /* A4(210) - marginå·¦å³(10*2) */
      min-height: 277mm;            /* A4(297) - marginä¸Šä¸‹(10*2) */
      margin: 12px auto 30px;
      background:#fff;
      overflow:hidden;
      border-radius: 10px;
      border: 1px solid #eef2ff;
    }

    /* ä»®ã‚¤ãƒ©ã‚¹ãƒˆï¼ˆãƒ˜ãƒƒãƒ€ãƒ¼/ãƒ•ãƒƒã‚¿ãƒ¼ï¼‰ */
    .bg-header{
      position:absolute;
      left:0; top:0;
      width:100%;
      height:40mm;
      pointer-events:none;
    }
    .bg-footer{
      position:absolute;
      left:0; bottom:0;
      width:100%;
      height:45mm;
      pointer-events:none;
    }

    /* ä¸­èº« */
    .content{
      position: relative;
      padding: 42mm 8mm 52mm; /* ä¸Šã¯ãƒ˜ãƒƒãƒ€ãƒ¼åˆ†ã€ä¸‹ã¯ãƒ•ãƒƒã‚¿ãƒ¼åˆ† */
    }

    .header-row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom: 6mm;
      flex-wrap:wrap;
    }
    .month-title{
      font-size: 28px;
      font-weight: 900;
      margin: 0;
      letter-spacing: .04em;
      text-shadow: 0 1px 0 rgba(255,255,255,.8);
    }
    .pdf-chip{
      border: 2px solid #bbf7d0;
      background: #dcfce7;
      padding: 8px 12px;
      border-radius: 999px;
      font-weight: 900;
      white-space: nowrap;
    }

    .notice{
      background: #fffbeb;
      border: 2px solid #fde68a;
      border-radius: 12px;
      padding: 6mm 8mm;
      font-weight: 900;
      color: #92400e;
      margin-bottom: 6mm;
    }

    /* ===== ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ï¼ˆç´™ã£ã½ã„ï¼‰ ===== */
    .calendar{
      border: 2px solid var(--line);
      border-radius: 14px;
      overflow:hidden;
      background:#fff;
    }
    .dow{
      display:grid;
      grid-template-columns: repeat(7, 1fr);
      background: linear-gradient(180deg, #f8fafc, #ffffff);
      border-bottom: 1px solid var(--line);
    }
    .dow div{
      text-align:center;
      padding: 5mm 0;
      font-weight: 900;
      color:#374151;
      letter-spacing: .08em;
    }
    .dow .sun{ color:#ef4444; }
    .dow .sat{ color:#3b82f6; }

    .grid{
      display:grid;
      grid-template-columns: repeat(7, 1fr);
    }

    .cell{
      min-height: 26mm;
      border-right: 1px solid var(--line);
      border-bottom: 1px solid var(--line);
      padding: 4mm;
      position: relative;
      background:#fff;
    }
    .cell:nth-child(7n){ border-right:none; }
    .cell.out{
      background:#fafafa;
      color:#9ca3af;
    }

    .day{
      font-weight: 900;
      font-size: 12px;
    }

    .act{
      margin-top: 6mm;
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding: 6px 10px;
      border-radius: 999px;
      font-weight: 900;
      font-size: 12px;
      border: 1px solid rgba(0,0,0,.06);
      max-width: 100%;
      white-space: nowrap;
    }
    .act .label{
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .foot{
      margin-top: 8mm;
      color: var(--muted);
      font-size: 11px;
      line-height: 1.5;
      border-top: 1px dashed var(--line);
      padding-top: 4mm;
    }

    .warn{
      margin-top: 8mm;
      border: 1px solid #fecaca;
      background:#fff1f2;
      color:#991b1b;
      border-radius: 12px;
      padding: 10px 12px;
      font-size: 12px;
      display:none;
      white-space: pre-wrap;
    }
  </style>
</head>

<body>
  <!-- ç”»é¢ç”¨ãƒ„ãƒ¼ãƒ«ãƒãƒ¼ï¼ˆå°åˆ·æ™‚ã¯æ¶ˆãˆã‚‹ï¼‰ -->
  <div class="toolbar">
    <div class="left">
      <strong id="toolTitle">é…å¸ƒç”¨PDF</strong>
      <small id="toolSub">ã“ã®ãƒšãƒ¼ã‚¸ã‚’ã€Œå°åˆ·ã€â†’ã€ŒPDFã«ä¿å­˜ã€ã§é…å¸ƒã§ãã¾ã™ã€‚</small>
    </div>
    <div class="right">
      <button id="backBtn">æˆ»ã‚‹</button>
      <button class="primary" id="pdfBtn">PDFå‡ºåŠ›</button>
      <button id="copyBtn">å…±æœ‰URLã‚³ãƒ”ãƒ¼</button>
    </div>
  </div>

  <div class="paper" id="paper">
    <!-- â–¼ ä»®ã‚¤ãƒ©ã‚¹ãƒˆï¼šãƒ˜ãƒƒãƒ€ãƒ¼ -->
    <svg class="bg-header" viewBox="0 0 800 160" preserveAspectRatio="none" aria-hidden="true">
      <defs>
        <linearGradient id="gSky" x1="0" y1="0" x2="0" y2="1">
          <stop offset="0%" stop-color="#dbeafe"/>
          <stop offset="100%" stop-color="#ffffff"/>
        </linearGradient>
        <filter id="soft" x="-20%" y="-20%" width="140%" height="140%">
          <feGaussianBlur stdDeviation="3"/>
        </filter>
      </defs>

      <rect x="0" y="0" width="800" height="160" fill="url(#gSky)"/>
      <!-- ãµã‚ãµã‚é›² -->
      <g opacity="0.35" filter="url(#soft)">
        <ellipse cx="120" cy="55" rx="70" ry="22" fill="#fff"/>
        <ellipse cx="170" cy="58" rx="55" ry="18" fill="#fff"/>
        <ellipse cx="610" cy="50" rx="70" ry="22" fill="#fff"/>
        <ellipse cx="660" cy="55" rx="55" ry="18" fill="#fff"/>
      </g>

      <!-- é³¥ -->
      <circle cx="72" cy="80" r="36" fill="#fde68a" opacity="0.95"/>
      <text x="72" y="90" text-anchor="middle" font-size="30">ğŸ¤</text>

      <!-- ã‚¿ã‚¤ãƒˆãƒ«è£…é£¾ -->
      <text x="135" y="95" font-size="44" font-weight="900" fill="#1f2937">ã‚«ãƒŠãƒªã‚¢é€šä¿¡</text>

      <!-- å³ä¸Šã®ã€ŒPDFå‡ºåŠ›ã€é¢¨ -->
      <g>
        <rect x="610" y="40" rx="18" ry="18" width="160" height="56" fill="#dcfce7" stroke="#bbf7d0" stroke-width="3"/>
        <text x="690" y="76" text-anchor="middle" font-size="20" font-weight="900" fill="#166534">PDFå‡ºåŠ›</text>
      </g>
    </svg>

    <div class="content">
      <div class="header-row">
        <h1 class="month-title" id="monthTitle">----å¹´--æœˆ</h1>
        <div class="pdf-chip">é…å¸ƒç”¨ï¼ˆå°åˆ· / PDFï¼‰</div>
      </div>

      <div class="notice">ğŸ“£ ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’ä½œæˆã—ã¾ã—ãŸï¼ãƒ—ãƒªãƒ³ãƒˆã‚¢ã‚¦ãƒˆã‚„å…±æœ‰ãŒã§ãã¾ã™â™ª</div>

      <div class="calendar">
        <div class="dow">
          <div class="sun">æ—¥</div><div>æœˆ</div><div>ç«</div><div>æ°´</div><div>æœ¨</div><div>é‡‘</div><div class="sat">åœŸ</div>
        </div>
        <div class="grid" id="calendarGrid"></div>
      </div>

      <div class="foot" id="footNote">
        â€»ã“ã®ãƒšãƒ¼ã‚¸ã¯é…å¸ƒç”¨ã®ã€Œè¦‹æœ¬ã€ã§ã™ã€‚å†…å®¹ã¯ä¿å­˜ã•ã‚ŒãŸäºˆå®šï¼ˆã¾ãŸã¯å…±æœ‰URLã®ãƒ‡ãƒ¼ã‚¿ï¼‰ã‹ã‚‰ç”Ÿæˆã•ã‚Œã¾ã™ã€‚<br>
        â€»PDFã«ã™ã‚‹æ™‚ã¯ã€ŒPDFå‡ºåŠ›ã€â†’å°åˆ·ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã§ã€ŒPDFã«ä¿å­˜ã€ã‚’é¸ã‚“ã§ãã ã•ã„ã€‚
      </div>

      <div class="warn" id="warnBox"></div>
    </div>

    <!-- â–¼ ä»®ã‚¤ãƒ©ã‚¹ãƒˆï¼šãƒ•ãƒƒã‚¿ãƒ¼ -->
    <svg class="bg-footer" viewBox="0 0 800 200" preserveAspectRatio="none" aria-hidden="true">
      <defs>
        <linearGradient id="gSea" x1="0" y1="0" x2="0" y2="1">
          <stop offset="0%" stop-color="#ecfeff"/>
          <stop offset="100%" stop-color="#ffffff"/>
        </linearGradient>
      </defs>

      <rect x="0" y="0" width="800" height="200" fill="url(#gSea)"/>

      <!-- èŠç”Ÿ/åœ°é¢ã£ã½ã„ -->
      <path d="M0,120 C120,90 220,150 360,120 C520,80 620,150 800,110 L800,200 L0,200 Z"
            fill="#dcfce7" opacity="0.9"/>

      <!-- éŠã³ã‚¢ã‚¤ã‚³ãƒ³ -->
      <text x="120" y="160" font-size="36">âš½ï¸</text>
      <text x="190" y="168" font-size="34">ğŸ¨</text>
      <text x="260" y="160" font-size="34">ğŸ²</text>
      <text x="330" y="168" font-size="34">ğŸ¤–</text>

      <!-- å­ã©ã‚‚ã£ã½ã„ä¸¸ -->
      <circle cx="620" cy="150" r="22" fill="#93c5fd"/>
      <circle cx="670" cy="150" r="22" fill="#fca5a5"/>
      <text x="645" y="170" text-anchor="middle" font-size="18">ğŸ™‚ğŸ™‚</text>
    </svg>
  </div>

<script>
(() => {
  // ========= æ´»å‹•ãƒã‚¹ã‚¿ï¼ˆindex/savedã¨æƒãˆã‚‹ï¼‰ =========
  const ACTIVITIES = [
    { id:"off",   label:"ãŠä¼‘ã¿",       emoji:"ğŸ˜¶", color:"#9ca3af" },
    { id:"sport", label:"é‹å‹•",         emoji:"ğŸƒ", color:"#3b82f6" },
    { id:"craft", label:"å·¥ä½œ",         emoji:"ğŸ¨", color:"#f59e0b" },
    { id:"game",  label:"ãƒ«ãƒ¼ãƒ«ã‚²ãƒ¼ãƒ ", emoji:"ğŸ²", color:"#a855f7" },
    { id:"kara",  label:"ã‚«ãƒ©ã‚ªã‚±",     emoji:"ğŸ¤", color:"#ef4444" },
    { id:"study", label:"å­¦ç¿’",         emoji:"ğŸ“š", color:"#16a34a" },
    { id:"planet",label:"ãƒ—ãƒ©ãƒã‚¿ãƒªã‚¦ãƒ ",emoji:"ğŸª", color:"#0ea5e9" },
    { id:"prog",  label:"ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°",emoji:"ğŸ¤–", color:"#111827" },
  ];
  const findAct = (id) => ACTIVITIES.find(a => a.id === id);

  // ========= localStorageã‚­ãƒ¼ï¼ˆä¿å­˜æ¸ˆã¿ãƒ‡ãƒ¼ã‚¿èª­ã‚ã‚‹ã‚ˆã†ã«ï¼‰ =========
  const LS_PREFIX = "kanaria_calendar_v1";
  const monthKey = (y,m)=> `${LS_PREFIX}:${y}-${String(m+1).padStart(2,"0")}`;

  // ========= util =========
  const pad2 = (n)=> String(n).padStart(2,"0");
  const ymd  = (y,m,d)=> `${y}-${pad2(m+1)}-${pad2(d)}`;

  function b64EncodeUtf8(str){
    const bytes = new TextEncoder().encode(str);
    let bin = "";
    bytes.forEach(b => bin += String.fromCharCode(b));
    return btoa(bin);
  }
  function b64DecodeUtf8(b64){
    const bin = atob(b64);
    const bytes = Uint8Array.from(bin, c => c.charCodeAt(0));
    return new TextDecoder().decode(bytes);
  }

  // ========= ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿å–å¾— =========
  // export.html?y=2025&m=12&data=....(base64 json)
  const params = new URLSearchParams(location.search);
  const y = Number(params.get("y"));
  const m = Number(params.get("m")); // 1-12
  const data = params.get("data");   // base64 JSON (assignments)

  const warnBox = document.getElementById("warnBox");
  const monthTitle = document.getElementById("monthTitle");
  const toolTitle = document.getElementById("toolTitle");

  // y,mãŒç„¡ã‘ã‚Œã°ç¾æœˆ
  const now = new Date();
  const year = Number.isFinite(y) && y > 0 ? y : now.getFullYear();
  const month1 = Number.isFinite(m) && m >= 1 && m <= 12 ? m : (now.getMonth()+1);
  const month0 = month1 - 1;

  monthTitle.textContent = `${year}å¹´${month1}æœˆ`;
  toolTitle.textContent  = `é…å¸ƒç”¨PDFï¼š${year}å¹´${month1}æœˆ`;

  // ========= assignments èª­ã¿è¾¼ã¿ï¼ˆå…±æœ‰URLå„ªå…ˆ â†’ ãªã‘ã‚Œã°localStorageï¼‰ =========
  let assignments = {};
  try{
    if(data){
      assignments = JSON.parse(b64DecodeUtf8(data));
    }else{
      const raw = localStorage.getItem(monthKey(year, month0));
      assignments = raw ? JSON.parse(raw) : {};
    }
  }catch(e){
    assignments = {};
    warnBox.style.display = "block";
    warnBox.textContent = "å…±æœ‰ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚\nURLãŒé€”ä¸­ã§åˆ‡ã‚Œã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚";
  }

  // ========= ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼æç”» =========
  const first = new Date(year, month0, 1);
  const last  = new Date(year, month0+1, 0);
  const firstDow = first.getDay();

  const grid = document.getElementById("calendarGrid");
  grid.innerHTML = "";

  // 6é€±(42ãƒã‚¹)å›ºå®šã§ä½œã‚‹ã¨å°åˆ·ãŒå®‰å®š
  let startDay = 1 - firstDow;
  for(let i=0; i<42; i++){
    const d = startDay + i;
    const inMonth = (d >= 1 && d <= last.getDate());

    const cell = document.createElement("div");
    cell.className = "cell" + (inMonth ? "" : " out");

    if(!inMonth){
      cell.innerHTML = `<div class="day">&nbsp;</div>`;
      grid.appendChild(cell);
      continue;
    }

    const key = ymd(year, month0, d);
    const actId = assignments[key];
    const act = actId ? findAct(actId) : null;

    cell.innerHTML = `
      <div class="day">${d}</div>
      ${act ? `
        <div class="act" style="background: color-mix(in oklab, ${act.color} 16%, #ffffff); border-color: color-mix(in oklab, ${act.color} 35%, #ffffff);">
          <span>${act.emoji}</span>
          <span class="label">${act.label}</span>
        </div>
      ` : ``}
    `;
    grid.appendChild(cell);
  }

  // ========= ãƒœã‚¿ãƒ³ =========
  // æˆ»ã‚‹ï¼šsaved.htmlãŒã‚ã‚‹å‰æï¼ˆãªã‘ã‚Œã°indexã¸ï¼‰
  document.getElementById("backBtn").addEventListener("click", ()=>{
    // export.html ã¯å…±æœ‰ã§ã‚‚é–‹ã‹ã‚Œã‚‹ã®ã§ã€æˆ»ã‚Šå…ˆã¯å®‰å…¨å´ã§ index ã«ã™ã‚‹
    location.href = `index.html?y=${year}&m=${month1}`;
  });

  // PDFå‡ºåŠ›ï¼šãƒ–ãƒ©ã‚¦ã‚¶ã®å°åˆ·ã‚’å‘¼ã¶
  document.getElementById("pdfBtn").addEventListener("click", ()=>{
    window.print();
  });

  // å…±æœ‰URLã‚³ãƒ”ãƒ¼ï¼šdataä»˜ãURLã‚’ç”Ÿæˆã—ã¦ã‚³ãƒ”ãƒ¼
  document.getElementById("copyBtn").addEventListener("click", async ()=>{
    const json = JSON.stringify(assignments);
    const b64 = b64EncodeUtf8(json);

    // åŒã˜ãƒ•ã‚©ãƒ«ãƒ€åŸºæº–ã§ export.html ã‚’ä½œã‚‹
    const base = location.href.replace(/\/[^\/]*$/, "/");
    const shareUrl = `${base}export.html?y=${year}&m=${month1}&data=${encodeURIComponent(b64)}`;

    try{
      await navigator.clipboard.writeText(shareUrl);
      alert("å…±æœ‰ç”¨URLã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼ˆã“ã®URLã‚’é€ã‚‹ã¨åŒã˜è¦‹ãŸç›®ã§PDFåŒ–ã§ãã¾ã™ï¼‰");
    }catch(e){
      prompt("ã‚³ãƒ”ãƒ¼ã§ããªã„å ´åˆã¯ã€ä¸‹ã®URLã‚’ã‚³ãƒ”ãƒ¼ã—ã¦ãã ã•ã„", shareUrl);
    }
  });
})();
</script>
</body>
</html>
